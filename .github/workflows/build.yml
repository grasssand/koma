name: Build Koma

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        python-version: '3.14'

    - name: Install FFmpeg
      shell: powershell
      run: |
        Write-Host "Downloading FFmpeg from GitHub (BtbN)..."
        $Url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
        $Output = "ffmpeg.zip"
        Invoke-WebRequest -Uri $Url -OutFile $Output
        Expand-Archive -Path $Output -DestinationPath "ffmpeg_temp" -Force
        $FFmpegBin = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -ExpandProperty DirectoryName -First 1
        Write-Host "Found FFmpeg binary at: $FFmpegBin"
        echo "$FFmpegBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8

    - name: Install dependencies
      run: uv sync --all-extras --all-groups

    - name: Lint with Ruff
      run: |
        uv run ruff check
        uv run ruff format --check

    - name: Run Tests
      run: uv run pytest
      env:
        CI: true

    - name: Build Lite Version (No FFmpeg)
      env:
        BUILD_WITH_FFMPEG: "false"
      run: |
        uv run pyinstaller build.spec --clean --noconfirm
        New-Item -ItemType Directory -Force -Path "staging/Lite"
        Move-Item -Path "dist/Koma.exe" -Destination "staging/Lite/Koma.exe"

    - name: Build Full Version (With FFmpeg)
      env:
        BUILD_WITH_FFMPEG: "true"
      run: |
        Remove-Item -Path "dist" -Recurse -ErrorAction SilentlyContinue
        uv run pyinstaller build.spec --clean --noconfirm
        New-Item -ItemType Directory -Force -Path "staging/Full"
        Move-Item -Path "dist/Koma.exe" -Destination "staging/Full/Koma.exe"

    - name: Package Application
      id: package
      shell: powershell
      run: |
        $Version = $env:GITHUB_REF_NAME

        $ZipLite = "Koma-Windows-x64_$Version.zip"
        Write-Host "Zipping Lite: $ZipLite"
        Compress-Archive -Path "staging/Lite/*" -DestinationPath "$ZipLite" -Force

        $ZipFull = "Koma-Windows-x64-with-FFmpeg_$Version.zip"
        Write-Host "Zipping Full: $ZipFull"
        Compress-Archive -Path "staging/Full/*" -DestinationPath "$ZipFull" -Force

        Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_FILES<<EOF"
        Add-Content -Path $env:GITHUB_ENV -Value "$ZipLite"
        Add-Content -Path $env:GITHUB_ENV -Value "$ZipFull"
        Add-Content -Path $env:GITHUB_ENV -Value "EOF"

    - name: Upload Artifact (Lite Version)
      uses: actions/upload-artifact@v6
      with:
        name: Koma-Lite-Build
        path: Koma-Windows-x64_*.zip
        if-no-files-found: error

    - name: Upload Artifact (Full Version)
      uses: actions/upload-artifact@v6
      with:
        name: Koma-Full-Build
        path: Koma-Windows-x64-with-FFmpeg_*.zip
        if-no-files-found: error

    - name: Release Notes
      shell: python
      if: github.ref_type == 'tag'
      run: |
        import os
        tag = os.environ.get("GITHUB_REF_NAME", "")
        notes = []
        recording = False
        try:
            with open("CHANGELOG.md", "r", encoding="utf-8") as f:
                for line in f:
                    if line.startswith(f"## {tag}"):
                        recording = True
                        continue
                    if recording and line.startswith("## v"):
                        break
                    if recording:
                        notes.append(line)
            with open("release_notes.txt", "w", encoding="utf-8") as f:
                f.write("".join(notes).strip())
        except Exception:
            with open("release_notes.txt", "w") as f:
                f.write(f"Release {tag}")

    - name: Release
      uses: softprops/action-gh-release@v2
      if: github.ref_type == 'tag'
      with:
        files: ${{ env.RELEASE_FILES }}
        body_path: release_notes.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
